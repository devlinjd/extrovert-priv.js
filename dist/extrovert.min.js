/*! extrovert 15-03-2015 */
var EXTROVERT=function(a,b,c){function d(a){return v()?(e(a),g(),f(A,z),h(),i(),j(),k(),!0):!1}function e(a){A=b.extend(!0,{},y,a),A.physics.enabled&&(Physijs.scripts.worker=A.physics.physijs.worker,Physijs.scripts.ammo=A.physics.physijs.ammo),z.generator=A.generator?"string"==typeof A.generator?new EXTROVERT[A.generator]:new EXTROVERT[A.generator.name]:new EXTROVERT.imitate,z.rasterizer=A.rasterizer||x.generate_image_texture,z.log=B}function f(a,b){b.generator.generate(a,b)}function g(){var d=b(A.container),e=d[0].getBoundingClientRect();z.width=e.right-e.left,z.height=e.bottom-e.top,z.renderer=new c.WebGLRenderer,z.renderer.setPixelRatio(a.devicePixelRatio),z.renderer.setSize(z.width,z.height),z.renderer.domElement.setAttribute("tabindex","0"),z.renderer.domElement.style+=" position: relative;",B.msg("Renderer: %o",z.renderer)}function h(){A.physics.enabled&&(z.gravity.set(A.gravity[0],A.gravity[1],A.gravity[2]),z.scene.setGravity(z.gravity),z.scene.addEventListener("update",m))}function i(){z.renderer.domElement.addEventListener("mousedown",r,!1),z.renderer.domElement.addEventListener("mouseup",t,!1),z.renderer.domElement.addEventListener("mousemove",s,!1),a.addEventListener("resize",u,!1)}function j(){z.start_time=z.last_time=Date.now()/1e3}function k(){b(A.container).replaceWith(z.renderer.domElement),A.onload&&A.onload(),l()}function l(){requestAnimationFrame(l),n()}function m(){}function n(){z.scene.simulate();{var a=Date.now()/1e3;a-z.last_time}if(z.last_time=a,!A.move_with_physics){null!==z.selected&&(z.selected.__dirtyPosition=!0);for(var b=0,c=z.card_coll.length;c>b;b++)z.card_coll[b].has_been_touched&&(z.card_coll[b].__dirtyPosition=!0)}z.renderer.clear(),z.renderer.render(z.scene,z.camera)}function o(a,b,c){var d=0>a?-1*a:a,e=Math.round,f=parseInt;if(b.length>7){var g=b.split(","),h=(c?c:0>a?"rgb(0,0,0)":"rgb(255,255,255)").split(","),i=f(g[0].slice(4)),j=f(g[1]),k=f(g[2]);return"rgb("+(e((f(h[0].slice(4))-i)*d)+i)+","+(e((f(h[1])-j)*d)+j)+","+(e((f(h[2])-k)*d)+k)+")"}var g=f(b.slice(1),16),h=f((c?c:0>a?"#000000":"#FFFFFF").slice(1),16),l=g>>16,m=g>>8&255,n=255&g;return"#"+(16777216+65536*(e(((h>>16)-l)*d)+l)+256*(e(((h>>8&255)-m)*d)+m)+(e(((255&h)-n)*d)+n)).toString(16).slice(1)}function p(a,b,c,d,e,f,g){for(var h=b.split("\n"),i=1,j=0;j<h.length;j++){for(var k="",l=h[j].split(" "),m=0;m<l.length;m++){var n=k+l[m]+" ",o=a.measureText(n),p=o.width;p>e?(g||a.fillText(k,c,d),k=l[m]+" ",d+=f,i++):k=n}g||a.fillText(k,c,d),d+=f}return i}function q(a){if(A.physics.enabled){var b=(new c.Matrix4).extractRotation(a.object.matrix),d=a.face.normal.clone().negate().multiplyScalar(3e4).applyMatrix4(b),e=a.point.clone().sub(a.object.position);a.object.applyImpulse(d,e)}}function r(a){a.preventDefault();var b=void 0===a.offsetX?a.layerX:a.offsetX,d=void 0===a.offsetY?a.layerY:a.offsetY;z.mouse=w(b,d,.5,z.mouse),z.raycaster.setFromCamera(z.mouse,z.camera);var e=z.raycaster.intersectObjects(z.card_coll);if(0!==e.length)if(a.ctrlKey)if(z.selected=e[0].object,z.selected.has_been_touched=!0,z.drag_plane.position.copy(z.selected.position),z.offset.copy(e[0].point).sub(z.selected.position),A.physics.enabled){var f=new c.Vector3(0,0,0);z.selected.setAngularFactor(f),z.selected.setLinearFactor(f),z.selected.setAngularVelocity(f),z.selected.setLinearVelocity(f)}else z.selected.temp_velocity=(new c.Vector3).copy(z.selected.velocity),z.selected.velocity.set(0,0,0);else q(e[0])}function s(a){a.preventDefault();var b=void 0===a.offsetX?a.layerX:a.offsetX,c=void 0===a.offsetY?a.layerY:a.offsetY;if(z.mouse=w(b,c,.5,z.mouse),z.selected){z.raycaster.setFromCamera(z.mouse,z.camera);var d=z.raycaster.intersectObject(z.drag_plane);if(A.move_with_physics){var e=d[0].point.sub(z.selected.position);e.z=0,z.selected.setLinearVelocity(e)}else z.selected.position.copy(d[0].point.sub(z.offset)),z.selected.__dirtyPosition=!0}}function t(a){if(a.preventDefault(),z.selected&&A.physics.enabled){if(A.physics.enabled){var b=new c.Vector3(1,1,1);z.selected.setAngularFactor(b),z.selected.setLinearFactor(b),z.selected.__dirtyPosition=!0}else{z.raycaster.setFromCamera(z.mouse,z.camera);var d=z.raycaster.intersectObject(z.drag_plane);z.selected.position.copy(d[0].point.sub(z.offset))}z.selected.updateMatrixWorld(),z.selected.updateMatrix()}z.selected=null}function u(){var a=z.renderer.domElement.parentNode.getBoundingClientRect();z.width=a.right-a.left,z.height=a.bottom-a.top,z.camera.aspect=z.width/z.height,z.camera.updateProjectionMatrix(),z.renderer.setSize(z.width,z.height),B.msg("window_resize( %d, %d a=%s)",z.width,z.height,z.camera.aspect.toString())}function v(b){if(a.WebGLRenderingContext){for(var c=document.createElement("canvas"),d=["webgl","experimental-webgl","moz-webgl","webkit-3d"],e=!1,f=0;4>f;f++)try{if(e=c.getContext(d[f]),e&&"function"==typeof e.getParameter)return b?{name:d[f],gl:e}:!0}catch(g){}return!1}return!1}function w(a,b,c,d){return d.x=a/z.width*2-1,d.y=2*-(b/z.height)+1,d.z=c,d}var x={};x.init=function(a){return d(a)},x.generator=function(a){return this.title=a,{generate:function(){}}};var y={src:{selector:"div",title:"h2"},generator:"gallery",rasterizer:x.generate_image_texture,container:"#container",gravity:[0,0,0],camera:{fov:35,near:1,far:2e3,position:[0,0,800],rotation:[0,0,0]},physics:{enabled:!0,materials:!1,physijs:{worker:"physijs_worker.js",ammo:"ammo.js"}},block:{width:128,height:64,depth:2},move_with_physics:!0,onload:null,onerror:null},z={camera:null,scene:null,renderer:null,raycaster:new c.Raycaster,mouse:new c.Vector2,width:100,height:100,gravity:new c.Vector3(y.gravity[0],y.gravity[1],y.gravity[2]),selected:null,start_time:0,last_time:0,card_coll:[],drag_plane:null,placement_plane:null,offset:new c.Vector3,generator:null},A=(new c.Vector3(0,0,0),null);x.create_camera=function(a){var b="orthographic"!=a.type?new c.PerspectiveCamera(a.fov,z.width/z.height,a.near,a.far):new c.OrthographicCamera(a.left,a.right,a.top,a.bottom,a.near,a.far);return b.position.set(a.position[0],a.position[1],a.position[2]),z.camera=b,b.updateMatrixWorld(),B.msg("Created camera: %o",z.camera),z.scene&&z.scene.add(z.camera),b},x.create_scene=function(a){var b=a.physics.enabled?new Physijs.Scene:new c.Scene;return z.scene=b,B.msg("Created scene: %o",b),b},x.fiat_lux=function(a){var d=[];return b.each(a,function(a,b){var e=null;"ambient"===b.type?e=new c.AmbientLight(b.color):"point"==b.type&&(e=new c.PointLight(b.color,b.intensity,b.distance),e.position.copy(b.pos?b.pos:z.camera.position)),z.scene.add(e),d.push(e)}),d},x.generate_image_texture=function(a){var b=document.createElement("canvas"),d=b.getContext("2d");b.width=a.width(),b.height=a.height();var e=a.get(0);d.drawImage(e,0,0,e.clientWidth,e.clientHeight);var f=new c.Texture(b);return f.needsUpdate=!0,{tex:f,mat:new c.MeshLambertMaterial({map:f})}},x.generate_texture=function(a){var b=a.find(A.src.title),d=b.text().trim(),e=document.createElement("canvas"),f=e.getContext("2d");e.width=a.width(),e.height=a.height();var g=a.css("background-color");"rgba(0, 0, 0, 0)"===g&&(g="rgb(0,0,0)"),f.fillStyle=g,f.fillRect(0,0,e.width,e.height);var h=a.children("img");h.length>0&&f.drawImage(h.get(0),0,0,e.width,e.height);var i=b.css("font-size");f.font="Bold "+i+" '"+b.css("font-family")+"'",f.fillStyle=b.css("color"),f.textBaseline="top";var j=24,k=p(f,d,10,10,e.width-20,j,!0);f.fillStyle=0===h.length?o(-.25,g):"rgba(0,0,0,0.75)",f.fillRect(0,0,e.width,20+k*j),f.fillStyle=b.css("color"),p(f,d,10,10,e.width-20,j,!1);var l=new c.Texture(e);return l.needsUpdate=!0,{tex:l,mat:new c.MeshLambertMaterial({map:l})}},x.calc_position=function(a,b){z.raycaster.setFromCamera(w(a,b,.5,new c.Vector3),z.camera);var d=z.raycaster.intersectObject(z.placement_plane);return d.length>0?d[0].point:null},x.calc_frustum=function(a){var b=2*Math.tan(a.fov*Math.PI/180/2)*a.near,d=b*a.aspect,e=2*Math.tan(a.fov*Math.PI/180/2)*a.far,f=e*a.aspect,g=a.position.z-a.near,h=a.position.z-a.far;return{nearPlane:{topLeft:new c.Vector3(-(d/2),b/2,g),topRight:new c.Vector3(d/2,b/2,g),botRight:new c.Vector3(d/2,-(b/2),g),botLeft:new c.Vector3(-(d/2),-(b/2),g)},farPlane:{topLeft:new c.Vector3(-(f/2),e/2,h),topRight:new c.Vector3(f/2,e/2,h),botRight:new c.Vector3(f/2,-(e/2),h),botLeft:new c.Vector3(-(f/2),-(e/2),h)}}};var B=function(){return{msg:function(){var a=Array.prototype.slice.call(arguments);console.log.apply(console,a)},warn:function(){var a=Array.prototype.slice.call(arguments);console.warn.apply(console,a)},error:function(){var a=Array.prototype.slice.call(arguments);console.error.apply(console,a)}}}();return x}(window,$,THREE);!function(a,b,c,d){function e(a,b){d.create_scene(a),d.create_camera(a.camera);var e=[];e[0]={type:"point",color:4294967295,intensity:1,distance:1e4},d.fiat_lux(e),b.drag_plane=new c.Mesh(new c.PlaneBufferGeometry(2e3,2e3,8,8),new c.MeshBasicMaterial({color:0,opacity:.25,transparent:!0})),b.drag_plane.visible=!1,b.log.msg("Building intersection plane: %o",b.drag_plane);var g=d.calc_frustum(b.camera),h=g.farPlane.topRight.x-g.farPlane.topLeft.x,i=g.farPlane.topRight.y-g.farPlane.botRight.y,j=a.background?c.ImageUtils.loadTexture(a.background):null,k=a.physics.enabled?new Physijs.BoxMesh(new c.BoxGeometry(h,i,10),new c.MeshLambertMaterial({color:16777215,map:j}),0):new c.Mesh(new c.BoxGeometry(h,i,10),new c.MeshLambertMaterial({color:3355443,map:j,opacity:1,transparent:!1}));k.position.z=g.farPlane.topRight.z,k.receiveShadow=!1,k.updateMatrix(),k.updateMatrixWorld(),b.scene.add(k),b.log.msg("Building base plane: %o",k),b.placement_plane=a.physics.enabled?new Physijs.BoxMesh(new c.BoxGeometry(2e5,2e5,1),new c.MeshBasicMaterial({color:11215651,opacity:1,transparent:!1}),0):new c.Mesh(new c.BoxGeometry(2e5,2e5,1),new c.MeshBasicMaterial({color:11215651,opacity:1,transparent:!1})),b.placement_plane.visible=!1,b.placement_plane.position.z=200,b.scene.updateMatrix(),b.placement_plane.updateMatrix(),b.placement_plane.updateMatrixWorld(),b.log.msg("Building placement plane: %o",b.placement_plane),f(a,b)}function f(a,d){d.side_mat=Physijs.createMaterial(new c.MeshLambertMaterial({color:4456448}),.2,1),b(a.src.selector).each(function(b,c){g(b,c,a,d)})}function g(a,e,f,g){var h=b(f.container).offset(),i=b(e).offset(),j={left:i.left-h.left,top:i.top-h.top},k=d.calc_position(j.left,j.top,g.placement_plane),l=d.calc_position(j.left+b(e).width(),j.top+b(e).height(),g.placement_plane),m=Math.abs(l.x-k.x),n=Math.abs(k.y-l.y),o=new c.BoxGeometry(m,n,f.block.depth),p=!0;p&&(o.computeFaceNormals(),o.computeVertexNormals());var q=k.x,r=k.y,s=k.z;q+=m/2,r-=n/2,s-=f.block.depth/2;var t=g.rasterizer(b(e),f),u=f.physics.enabled&&f.physics.materials?Physijs.createMaterial(t.mat,.2,1):t.mat,v=new c.MeshFaceMaterial([g.side_mat,g.side_mat,g.side_mat,g.side_mat,u,u]),w=f.physics.enabled?new Physijs.BoxMesh(o,v,1e3):new c.Mesh(o,v);if(w.position.set(q,r,s),w.castShadow=w.receiveShadow=!1,g.scene.add(w),f.physics.enabled);else w.velocity=new c.Vector3((Math.random()-.5)/5,(Math.random()-.5)/5,(Math.random()-.5)/5);return w.elem=b(e),g.card_coll.push(w),g.log.msg("Created element %d (%f, %f, %f): %o.",a,q,r,s,w),w}d.gallery=function(){return{generate:function(a,b){e(a,b)}}}}(window,$,THREE,EXTROVERT),function(a,b,c,d){function e(a,b){d.create_scene(a),d.create_camera(a.camera);var e=[];e[0]={type:"ambient",color:268435455},d.fiat_lux(e),b.drag_plane=new c.Mesh(new c.PlaneBufferGeometry(2e3,2e3,8,8),new c.MeshBasicMaterial({color:0,opacity:.25,transparent:!0})),b.drag_plane.visible=!1,b.log.msg("Building intersection plane: %o",b.drag_plane);var g=a.physics.enabled?new Physijs.BoxMesh(new c.BoxGeometry(2e3,2e3,10),new c.MeshBasicMaterial({color:3355443}),0):new c.Mesh(new c.BoxGeometry(2e3,2e3,10),new c.MeshBasicMaterial({color:3355443,opacity:1,transparent:!1}));g.position.z=-500,g.receiveShadow=!0,b.scene.add(g),b.log.msg("Building base plane: %o",g),b.placement_plane=a.physics.enabled?new Physijs.BoxMesh(new c.BoxGeometry(2e5,2e5,1),new c.MeshBasicMaterial({color:11215651,opacity:1,transparent:!1}),0):new c.Mesh(new c.BoxGeometry(2e5,2e5,1),new c.MeshBasicMaterial({color:11215651,opacity:1,transparent:!1})),b.placement_plane.visible=!1,b.placement_plane.position.z=200,b.scene.updateMatrix(),b.placement_plane.updateMatrix(),b.placement_plane.updateMatrixWorld(),b.log.msg("Building placement plane: %o",b.placement_plane),f(a,b)}function f(a,c){b(a.src.selector).each(function(b,d){h(b,d,a,c)})}function g(a){for(i=0;i<a.faces.length;i++){var b=a.faces[i],c=(a.vertices[b.a],a.vertices[b.b],a.vertices[b.c],a.faceVertexUvs[0][i]);b.normal.y>.9?c[0].x=c[0].y=c[1].x=c[1].y=c[2].x=c[2].y=.99:b.normal.y<-.9?c[0].x=c[0].y=c[1].x=c[1].y=c[2].x=c[2].y=.01:(b.normal.x>.9||b.normal.x<-.9)&&(c[0].x=c[0].x>.5?.02:0,c[1].x=c[1].x>.5?.02:0,c[2].x=c[2].x>.5?.02:0)}a.uvsNeedUpdate=!0}function h(a,e,f,h){var i=b(f.container).offset(),j=b(e).offset(),k={left:j.left-i.left,top:j.top-i.top},l=d.calc_position(k.left,k.top,h.placement_plane),m=d.calc_position(k.left+b(e).width(),k.top+b(e).height(),h.placement_plane),n=Math.abs(m.x-l.x),o=Math.abs(l.y-m.y),p=new c.BoxGeometry(n,o,f.block.depth);g(p);var q=h.rasterizer(b(e),f),r=l.x,s=l.y,t=l.z;r+=n/2,s-=o/2,t-=f.block.depth/2;var u=f.physics.enabled&&f.physics.materials?Physijs.createMaterial(q.mat,.2,1):q.mat,v=f.physics.enabled?new Physijs.BoxMesh(p,u,1e3):new c.Mesh(p,u);if(v.position.set(r,s,t),v.castShadow=v.receiveShadow=!0,h.scene.add(v),f.physics.enabled);else v.velocity=new c.Vector3((Math.random()-.5)/5,(Math.random()-.5)/5,(Math.random()-.5)/5);return v.elem=b(e),h.card_coll.push(v),h.log.msg("Created element %d (%f, %f, %f): %o.",a,r,s,t,v),v}d.imitate=function(){return{generate:function(a,b){e(a,b)}}}}(window,$,THREE,EXTROVERT);